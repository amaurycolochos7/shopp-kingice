<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Pedidos | King Ice Gold Admin</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <div class="admin-sidebar-logo">
                    KING ICE GOLD
                    <span>Panel de Administraci√≥n</span>
                </div>
            </div>

            <nav class="admin-nav">
                <div class="admin-nav-section">
                    <p class="admin-nav-title">Principal</p>
                    <a href="dashboard.html" class="admin-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Dashboard
                    </a>
                </div>

                <div class="admin-nav-section">
                    <p class="admin-nav-title">Cat√°logo</p>
                    <a href="products.html" class="admin-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z">
                            </path>
                            <line x1="7" y1="7" x2="7.01" y2="7"></line>
                        </svg>
                        Productos
                    </a>
                    <a href="categories.html" class="admin-nav-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                        Categor√≠as
                    </a>
                </div>

                <div class="admin-nav-section">
                    <p class="admin-nav-title">Ventas</p>
                    <a href="orders.html" class="admin-nav-link active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                            <path d="M3 6h18"></path>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                        Pedidos
                    </a>
                </div>
            </nav>

            <div class="admin-sidebar-footer">
                <a href="#" class="admin-logout" id="logoutBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Cerrar sesi√≥n
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="admin-header-title">Pedidos</h1>
                <div class="admin-header-actions">
                    <select class="admin-form-select" style="width: 180px;" id="statusFilter">
                        <option value="all">Todos los estados</option>
                        <option value="pending">Pendientes</option>
                        <option value="paid">Pagados</option>
                        <option value="shipped">Enviados</option>
                        <option value="delivered">Entregados</option>
                        <option value="cancelled">Cancelados</option>
                    </select>
                </div>
            </header>

            <div class="admin-content">
                <!-- Orders Table -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h2 class="admin-card-title">Todos los Pedidos (<span id="orderCount">0</span>)</h2>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th style="width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <!-- Contenido din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Ver Detalles del Pedido -->
    <div class="admin-modal-overlay" id="orderModal">
        <div class="admin-modal" style="max-width: 700px;">
            <div class="admin-modal-header">
                <h3 class="admin-modal-title" id="modalTitle">Detalles del Pedido</h3>
                <span class="admin-modal-close" id="closeModal">&times;</span>
            </div>
            <div class="admin-modal-body" id="orderDetails">
                <!-- Contenido din√°mico -->
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="admin-btn admin-btn-secondary" id="closeBtn">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script>
        const STATUS_LABELS = {
            pending: 'Pendiente',
            paid: 'Pagado',
            shipped: 'Enviado',
            delivered: 'Entregado',
            cancelled: 'Cancelado'
        };

        const STATUS_CLASSES = {
            pending: 'badge-pending',
            paid: 'badge-paid',
            shipped: 'badge-shipped',
            delivered: 'badge-delivered',
            cancelled: 'badge-cancelled'
        };

        document.addEventListener('DOMContentLoaded', function () {
            if (!KIG.Auth.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            loadOrders();
            setupEventListeners();
            setupLogout();
            checkUrlParams();
        });

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);

            const filter = params.get('filter');
            if (filter) {
                document.getElementById('statusFilter').value = filter;
                loadOrders(filter);
            }

            const orderId = params.get('id');
            if (orderId) {
                viewOrder(orderId);
            }
        }

        function loadOrders(statusFilter = 'all') {
            let orders = KIG.Orders.getAll().sort((a, b) =>
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            if (statusFilter !== 'all') {
                orders = orders.filter(o => o.status === statusFilter);
            }

            const tbody = document.getElementById('ordersTable');
            document.getElementById('orderCount').textContent = orders.length;

            if (orders.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--admin-text-muted);">
              No hay pedidos ${statusFilter !== 'all' ? 'con este estado' : 'a√∫n'}
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
        <tr>
          <td>
            <a href="#" onclick="viewOrder('${order.id}'); return false;" style="color: var(--color-primary);">
              ${order.orderNumber}
            </a>
          </td>
          <td>
            <strong>${order.customer.name}</strong><br>
            <span style="font-size: 0.8rem; color: var(--admin-text-muted);">${order.customer.phone}</span>
          </td>
          <td>${order.items.length} producto(s)</td>
          <td>${KIG.formatPrice(order.total)}</td>
          <td>
            <span class="badge ${STATUS_CLASSES[order.status]}">${STATUS_LABELS[order.status]}</span>
          </td>
          <td>${new Date(order.createdAt).toLocaleDateString('es-MX')}</td>
          <td>
            <button class="admin-btn admin-btn-icon" onclick="viewOrder('${order.id}')" title="Ver detalles">üëÅÔ∏è</button>
          </td>
        </tr>
      `).join('');
        }

        function setupEventListeners() {
            // Filtro de estado
            document.getElementById('statusFilter').addEventListener('change', (e) => {
                loadOrders(e.target.value);

                // Update URL
                const url = new URL(window.location);
                if (e.target.value === 'all') {
                    url.searchParams.delete('filter');
                } else {
                    url.searchParams.set('filter', e.target.value);
                }
                window.history.pushState({}, '', url);
            });

            // Cerrar modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeBtn').addEventListener('click', closeModal);
            document.getElementById('orderModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
        }

        function viewOrder(orderId) {
            const order = KIG.Orders.getById(orderId);
            if (!order) return;

            const modal = document.getElementById('orderModal');
            document.getElementById('modalTitle').textContent = `Pedido ${order.orderNumber}`;

            const addr = order.customer.address;

            document.getElementById('orderDetails').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-lg);">
          <!-- Informaci√≥n del cliente -->
          <div style="background: var(--admin-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-md);">
            <h4 style="color: var(--admin-text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: var(--spacing-md);">Cliente</h4>
            <p style="color: var(--admin-text); margin-bottom: 4px;"><strong>${order.customer.name}</strong></p>
            <p style="color: var(--admin-text-muted); font-size: 0.9rem;">üìß ${order.customer.email}</p>
            <p style="color: var(--admin-text-muted); font-size: 0.9rem;">üì± ${order.customer.phone}</p>
          </div>
          
          <!-- Direcci√≥n de env√≠o -->
          <div style="background: var(--admin-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-md);">
            <h4 style="color: var(--admin-text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: var(--spacing-md);">Direcci√≥n de Env√≠o</h4>
            <p style="color: var(--admin-text); font-size: 0.9rem;">
              ${addr.street}<br>
              ${addr.colony}, C.P. ${addr.zip}<br>
              ${addr.city}, ${addr.state}
              ${addr.references ? `<br><em style="color: var(--admin-text-muted);">Ref: ${addr.references}</em>` : ''}
            </p>
          </div>
        </div>
        
        <!-- Productos -->
        <div style="margin-top: var(--spacing-lg);">
          <h4 style="color: var(--admin-text); font-size: 0.9rem; margin-bottom: var(--spacing-md);">Productos</h4>
          ${order.items.map(item => {
                const options = Object.values(item.options || {}).join(', ');
                return `
              <div style="display: flex; justify-content: space-between; padding: var(--spacing-md); background: var(--admin-bg); border-radius: var(--border-radius-sm); margin-bottom: var(--spacing-sm);">
                <div>
                  <p style="color: var(--admin-text);">${item.name}</p>
                  <p style="color: var(--admin-text-muted); font-size: 0.8rem;">${options || 'Sin opciones'} √ó ${item.quantity}</p>
                </div>
                <p style="color: var(--admin-text);">${KIG.formatPrice(item.price * item.quantity)}</p>
              </div>
            `;
            }).join('')}
        </div>
        
        <!-- Totales -->
        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-lg); background: var(--admin-bg); border-radius: var(--border-radius-md);">
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
            <span style="color: var(--admin-text-muted);">Subtotal</span>
            <span style="color: var(--admin-text);">${KIG.formatPrice(order.subtotal)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-sm);">
            <span style="color: var(--admin-text-muted);">Env√≠o</span>
            <span style="color: var(--admin-text);">${KIG.formatPrice(order.shipping)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding-top: var(--spacing-md); border-top: 1px solid rgba(255,255,255,0.1);">
            <span style="color: var(--admin-text); font-weight: 600;">Total</span>
            <span style="color: var(--color-primary); font-weight: 600; font-size: 1.1rem;">${KIG.formatPrice(order.total)}</span>
          </div>
        </div>
        
        <!-- Estado -->
        <div style="margin-top: var(--spacing-lg);">
          <h4 style="color: var(--admin-text); font-size: 0.9rem; margin-bottom: var(--spacing-md);">Cambiar Estado</h4>
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            ${Object.entries(STATUS_LABELS).map(([value, label]) => `
              <button class="admin-btn ${order.status === value ? 'admin-btn-primary' : 'admin-btn-secondary'}" 
                onclick="updateOrderStatus('${order.id}', '${value}')"
                ${order.status === value ? 'disabled' : ''}>
                ${label}
              </button>
            `).join('')}
          </div>
        </div>
        
        <!-- Historial -->
        <div style="margin-top: var(--spacing-lg);">
          <h4 style="color: var(--admin-text); font-size: 0.9rem; margin-bottom: var(--spacing-md);">Historial</h4>
          <div style="max-height: 150px; overflow-y: auto;">
            ${order.statusHistory.map(h => `
              <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <span class="badge ${STATUS_CLASSES[h.status]}">${STATUS_LABELS[h.status]}</span>
                <span style="color: var(--admin-text-muted); font-size: 0.8rem;">
                  ${new Date(h.date).toLocaleString('es-MX')}
                </span>
              </div>
            `).reverse().join('')}
          </div>
        </div>
      `;

            modal.classList.add('active');
        }

        function updateOrderStatus(orderId, newStatus) {
            const statuses = ['pending', 'paid', 'shipped', 'delivered', 'cancelled'];
            const labels = ['Pendiente', 'Pagado', 'Enviado', 'Entregado', 'Cancelado'];

            const statusLabel = labels[statuses.indexOf(newStatus)];

            if (confirm(`¬øCambiar estado a "${statusLabel}"?`)) {
                KIG.Orders.updateStatus(orderId, newStatus);
                viewOrder(orderId); // Refrescar modal
                loadOrders(document.getElementById('statusFilter').value);
            }
        }

        function closeModal() {
            document.getElementById('orderModal').classList.remove('active');

            // Remove order ID from URL
            const url = new URL(window.location);
            url.searchParams.delete('id');
            window.history.pushState({}, '', url);
        }

        function setupLogout() {
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('¬øCerrar sesi√≥n?')) {
                    KIG.Auth.logout();
                    window.location.href = 'login.html';
                }
            });
        }
    </script>
</body>

</html>